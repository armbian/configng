name: "Maintenance: Unit tests"
on:
  workflow_dispatch:
  repository_dispatch:
    types: ["Unit tests"]
  schedule:
    - cron: '0 2 * * *'
  pull_request:
    types: [opened, reopened, edited, synchronize, review_requested]

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  PR_NUMBER: ${{ github.event.number }}
  REPOSITORY: "apt.armbian.com"

concurrency:
  group: pipeline-pr-${{github.event.pull_request.number}}
  cancel-in-progress: false

jobs:

  prepare:
    name: "Armbian configurator unit tests"
    runs-on: "ubuntu-24.04"
    outputs:
      DEPLOYMENT_MATRIX: "${{ steps.json.outputs.DEPLOYMENT_MATRIX }}"
    steps:

      - name: Checkout
        uses: actions/checkout@v6

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
              tests/*.conf
          separator: "\n"

      - name: "Make JSON ${{ steps.changed-files.outputs.all_changed_files }}"
        id: json
        run: |

          delimiter="$(openssl rand -hex 8)"
          echo "DEPLOYMENT_MATRIX<<${delimiter}" >> "${GITHUB_OUTPUT}"
          # define OS variants and their Docker images - use pre-built Armbian images
          declare -A docker_images=(
            ["bookworm"]="ghcr.io/armbian/repository-update:bookworm-amd64"
            ["trixie"]="ghcr.io/armbian/repository-update:trixie-amd64"
            ["forky"]="ghcr.io/armbian/repository-update:forky-amd64"
            ["jammy"]="ghcr.io/armbian/repository-update:jammy-amd64"
            ["noble"]="ghcr.io/armbian/repository-update:noble-amd64"
            ["resolute"]="ghcr.io/armbian/repository-update:resolute-amd64"
          )
          images=("bookworm" "trixie" "forky" "jammy" "noble" "resolute")
          # read tests cases
          # Run all tests on schedule, workflow_dispatch on main, or when no files changed
          run_all_tests=false
          if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.ref_name }}" == "main" && "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ steps.changed-files.outputs.any_changed }}" != "true" ]]; then
              run_all_tests=true
          fi

          if [[ "$run_all_tests" == "true" ]]; then
              tests=($(grep -rwl tests/*.conf -e "ENABLED=true" | cut -d":" -f1))
          else
              # Get changed test files using git to avoid parsing issues
              changed_tests=($(cd "${GITHUB_WORKSPACE}" && git diff --name-only origin/main...HEAD | grep '^tests/.*\.conf$' || true))
              if [[ ${#changed_tests[@]} -gt 0 ]]; then
                  # Filter for ENABLED=true
                  tests=($(grep -rwl -e "ENABLED=true" -- "${changed_tests[@]}" 2>/dev/null | cut -d":" -f1))
              else
                  tests=()
              fi
          fi
          # loop enabled test cases
          for i in "${tests[@]}"; do
             unset RELEASE
             source "${i}"
             if [[ -z "${RELEASE}" || "${RELEASE}" == "all" ]]; then RELEASE=all; fi
             # if we specify releases, we need to loop docker images and use if there is a match
             if [[ $RELEASE != "all" ]]; then
                for j in ${images[@]}; do
                    elements=($(echo $RELEASE | tr ':' "\n"))
                    testid=($(echo $i | cut -d"/" -f2 | cut -d"." -f1))
                    for SELECTED_RELEASE in "${elements[@]}"; do
                        if [[ $j == *"${SELECTED_RELEASE}"* ]]; then
                           echo "{\"package\":\"${i}\",\"name\":\"${TESTNAME}\",\"os\":\"$j\",\"id\":\"$testid\",\"docker_image\":\"${docker_images[$j]}\"}"
                        fi
                    done
                done
             else
                for j in ${images[@]}; do
                    testid=($(echo $i | cut -d"/" -f2 | cut -d"." -f1))
                    echo "{\"package\":\"${i}\",\"name\":\"${TESTNAME}\",\"os\":\"$j\",\"id\":\"$testid\",\"docker_image\":\"${docker_images[$j]}\"}"
                done
             fi
          done | jq -s >> $GITHUB_OUTPUT
          echo "${delimiter}" >> "${GITHUB_OUTPUT}"

  gradle:
    needs: prepare
    if: ${{ needs.prepare.outputs.DEPLOYMENT_MATRIX != '[]' }}
    strategy:
      fail-fast: false
      max-parallel: 128
      matrix:
        server: ${{ fromJSON(needs.prepare.outputs.DEPLOYMENT_MATRIX) }}
    name: "${{ matrix.server.name }} (${{ matrix.server.os }})"
    #runs-on: "ubuntu-latest"
    runs-on: [ docker, X64 ]
    timeout-minutes: 15
    container:
      image: ${{ matrix.server.docker_image }}
      options: --privileged --security-opt seccomp=unconfined --tmpfs /tmp --tmpfs /run --tmpfs /run/lock
      env:
        DBUS_SESSION_BUS_ADDRESS: unix:path=/run/bus/bus.sock
    steps:

      - name: "Initialize systemd"
        run: |
          # Start systemd in the container
          /sbin/init &
          sleep 5
          # Make the container appear as if systemd is PID 1
          export SYSTEMD_IGNORE_CHROOT=1
          export container=docker

      - name: "Checkout Armbian configuration tool"
        uses: actions/checkout@v6
        with:
          path: 'config'

      - name: "Run unit test: ${{ matrix.server.name }} via ${{ matrix.server.package }}"
        shell: bash
        run: |
          export TERM=linux
          rm -rf test; mkdir -p test
          cd config
          # assemble armbian config
          bash tools/config-assemble.sh -p
          # read test
          source "${{ matrix.server.package }}"

          # Test case execution
          start_time=$(date +%s)
          figlet  "RUN TEST CASE"
          testcase # function inside test script
          finish_time=$(date +%s)

          # Generate table entry
          echo "|${{ matrix.server.os }}| ${{ matrix.server.name }} | $((finish_time - start_time)) sec |" > ../test/${{ matrix.server.id }}-${{ matrix.server.os }}

      - name: "Upload test summary"
        uses: actions/upload-artifact@v6
        with:
          name: test-${{ matrix.server.id }}-${{ matrix.server.os }}
          path: test
          if-no-files-found: ignore

  stop:
    name: "Merge test artifacts"
    if: always()
    needs: gradle
    runs-on: ubuntu-24.04
    steps:

      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          path: test
          pattern: test-*
          merge-multiple: true

      - name: Install
        run: |

          echo "# Succesful tests:" >> $GITHUB_STEP_SUMMARY
          echo "|Release|Test name|Duration|" >> $GITHUB_STEP_SUMMARY
          echo "|:---|:---|---:|" >> $GITHUB_STEP_SUMMARY
          cat test/* | sed '$ s/.$//' >> $GITHUB_STEP_SUMMARY

      - uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            test-*
