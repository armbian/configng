#!/bin/bash
#
# SPDX-License-Identifier: GPL-2.0
#
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/


directory="$(dirname "${BASH_SOURCE[0]}")"
cd "$directory" || exit
filename="$(basename "${BASH_SOURCE[0]}")" ;
libpath="$directory/../lib"

# Set the tui
if command -v whiptail > /dev/null; then
   DIALOG=whiptail
elif command -v dialog > /dev/null; then
   DIALOG=dialog
else
    echo "Error: Neither whiptail nor dialog is installed."
    exit 1
fi

# Source the external file                              lib/armbian-build/commands.sh
script_path="$(dirname "$(dirname "$(realpath "$0")")")/lib/armbian-build/commands.sh"

# Use awk to extract the array
ARMBIAN_COMMANDS_TO_HANDLERS_DICT=$(awk '/declare -g -A ARMBIAN_COMMANDS_TO_HANDLERS_DICT=/,/^(\}|[[:space:]]*\))/ {print}' "$script_path")

# Execute the array definition
eval "$ARMBIAN_COMMANDS_TO_HANDLERS_DICT"

# Now you can use the array in this script
#echo "Array keys: ${!ARMBIAN_COMMANDS_TO_HANDLERS_DICT[@]}"


# EN ARMBIAN_COMMANDS_TO_HANDLERS_DICT Descritions Groups
declare -A COMMAND_DESCRIPTIONS_EN=(
    ["docker"]="Manage Docker containers"
    ["requirements"]="Install system requirements"
    ["config_dump_json"]="Dump configuration to JSON"
    ["json_info"]="Display JSON information"
    ["patch_kernel"]="Apply kernel patches"
    ["standard_build"]="Perform standard build"
    ["distccd"]="Set up distccd"
    ["flash"]="Flash firmware"
    ["requirements"]="Install system requirements"
    ["config_dump_json"]="Dump configuration to JSON"
    ["json_info"]="Display JSON information"
    ["patch_kernel"]="Apply kernel patches"
    ["standard_build"]="Perform standard build"
    ["distccd"]="Set up distccd"
    ["flash"]="Flash firmware"
)

generate_descriptions() {
    mapfile -t commands < <(printf '%s\n' "${!ARMBIAN_COMMANDS_TO_HANDLERS_DICT[@]}")

    local i=1
    local command
    local description

    for command in "${commands[@]}"; do
        description="${COMMAND_DESCRIPTIONS_EN[${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}]}"
        handler="${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}"
        printf '%d %s  - %s\n    ["%s"]="%s"\n' "$i" "$command" "$description" "$command" "$handler"
        ((i++))
    done
}

generate_json() {
    local i=1
    local command
    local description
    mapfile -t commands < <(printf '%s\n' "${!ARMBIAN_COMMANDS_TO_HANDLERS_DICT[@]}")

    # Start JSON array
    json_output="["

    for command in "${commands[@]}"; do
        description="${COMMAND_DESCRIPTIONS_EN[${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}]}"
        handler="${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}"

        if [[ $i -gt 1 ]]; then
            json_output+=", "
        fi

        # Append JSON object to the array
        json_output+=$(printf '{"command": "%s", "description": "%s", "handler": "%s"}' "$command" "$description" "$handler")

        ((i++))
    done

    # End JSON array
    json_output+="]"

    # Print the formatted JSON
    echo "$json_output" | jq
}

# html output
generate_html() {
    local i=1
    local command
    local description
    mapfile -t commands < <(printf '%s\n' "${!ARMBIAN_COMMANDS_TO_HANDLERS_DICT[@]}")

    # Start HTML content
    html_output="<html><body><h1>Armbian Build Framework Commands</h1><ul>"

    for command in "${commands[@]}"; do
        description="${COMMAND_DESCRIPTIONS_EN[${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}]}"
        handler="${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}"

        # Append HTML list item to the content
        html_output+="<li><strong>$command</strong>: $description (Handler: $handler)</li>"

        ((i++))
    done

    # End HTML content
    html_output+="</ul></body></html>"

    # Print the formatted HTML
    echo "$html_output"
}

main_menu(){
	# Define the script
	script="./armbian-build-docs"


	# Run the script with the -h option and save the output to a variable
	help_message=$("$script" -h ) || exit 2

	# Reformat the help message into an array line by line
	readarray -t script_launcher < <(echo "$help_message" | sed 's/-\([a-zA-Z]\)/\1/' | grep '^  [a-zA-Z] ' | grep -v '\[')

	# Loop through each line in the array and create a menu string
	menu_string=""
	for line in "${script_launcher[@]}"; do
	  # Append the formatted line to the menu string
	  menu_string+="$line\n"
	done

	# Use the get_help_msg function and pipe its output into configng-interface -m
	selected_option=$(echo -e "$menu_string" | ./armbian-interface -m  )

	# Run the armbian-monitor script with the selected option
	[[ -n "$selected_option" ]] && "$script" -"$selected_option"  | ./armbian-interface -o ;

	}

# TUI Menu
generate_tui() {

    local i=0
    local command
    local description
# Get terminal size
lines=$(stty size | cut -d' ' -f1)
columns=$(stty size | cut -d' ' -f2)

# Adjust border size
border_height=$((lines - 6 ))
border_width=$((columns - 6 ))

	if command -v whiptail > /dev/null; then
	   local DIALOG=whiptail
	elif command -v dialog > /dev/null; then
	   local DIALOG=dialog
	else
	    echo "Error: Neither whiptail nor dialog is installed."
	    exit 1
	fi

	for command in "${!ARMBIAN_COMMANDS_TO_HANDLERS_DICT[@]}"; do
        description="${COMMAND_DESCRIPTIONS_EN[${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}]}"
        handler="${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}"
        options+=("$i" "$command - $description")
		results+=("[$command]=\"$handler\"")
        ((i++))
    done 

#   choice=$($DIALOG --title "Config Options" --menu "Choose an option:" $menu_height $menu_width $border_height $border_width "${options[@]}" 3>&1 1>&2 2>&3)

	choice=$($DIALOG --title "Config Options" --menu "Choose an option:" "$border_height" "$border_width" 0 "${options[@]}" 3>&1 1>&2 2>&3)
	echo -e "Choice $choice Result:\n\t ${results[$choice]}" | show_message
	}

# TUI OK message
show_message(){

    # Read the input from the pipe continuously until there is no more input
    input=""
    while read -r line; do
        input+="$line\n"
    done

    # Display the "OK" message box with the input data
    $DIALOG --title "Message Box" --msgbox "$input" 0 0
    clear
    }

generate_bash() {
    local i=1
    local command
    local description

    for command in "${!ARMBIAN_COMMANDS_TO_HANDLERS_DICT[@]}"; do
        description=${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}
        printf '  ["%s"]="%s"\n'  "$command" "$description"
        ((i++))
    done
}

# Bash menu
generate_menu() {
    local i=1
    local command
    local description

    echo "Config Options:"
    for command in "${!ARMBIAN_COMMANDS_TO_HANDLERS_DICT[@]}"; do
        description="${COMMAND_DESCRIPTIONS_EN[${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}]}"
        handler="${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}"
        echo "$i. $command - $description"
        ((i++))
    done

    read -p "Choose an option (enter the number): " choice

    if [[ $choice -ge 1 && $choice -le ${#ARMBIAN_COMMANDS_TO_HANDLERS_DICT[@]} ]]; then
        echo -e "Choice $choice Result:\n\t []=\${[]}"
    else
        echo "Invalid choice. Please enter a valid number."
    fi
}

generate_markdown() {
    local i=1
    local command
    local description
    mapfile -t commands < <(printf '%s\n' "${!ARMBIAN_COMMANDS_TO_HANDLERS_DICT[@]}")

    # Start Markdown content
    markdown_output="# Armbian Build Framework Commands\n"

    for command in "${commands[@]}"; do
        description="${COMMAND_DESCRIPTIONS_EN[${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}]}"
        handler="${ARMBIAN_COMMANDS_TO_HANDLERS_DICT[$command]}"

        # Append Markdown list item to the content
        markdown_output+="\n## $command\n- **Description:** $description\n- **Handler:** $handler\n"

        ((i++))
    done

    # Print the formatted Markdown
    echo -e "$markdown_output"
}

generate_help_message() {
    echo "Usage: $0 [options]"
    echo "Options:"
    echo "  -h  Display this help message "
    echo "  -t  Generate TUI output "
    echo "  -n  Generate Numbered output "
	echo "  -j  Generate json output "
    echo "  -b  Generate Bash key pairs output "
    echo "  -m  Generate Markdown output "
    echo "  -H  Generate HTML output "
}

# Call the function

while getopts "bhHjmnt" opt; do
    case "$opt" in

	b)  generate_bash ; exit 0 ;;
	h)  generate_help_message ; exit 0 ;;
	H)  generate_html ; exit 0 ;;
	j)  generate_json ; exit 0 ;;
	m)  generate_markdown ; exit 0 ;;
	n)  generate_descriptions ; exit 0 ;;
	t)  generate_tui ; exit 0 ;;
	*) echo "Invalid option"; generate_help_message ; exit 1 ;;
    esac
done

if [[ $1 == *"--"* ]]; then
     echo "Error: Invalid option detected"
     exit 1
elif [[ -n $1 ]] && ! [[ $1 == --* || $1 == -* ]]; then
     bash ./compile.sh "$@"
elif [[ -z $1 ]]; then
     main_menu  ; exit 0 ;
fi
